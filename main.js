/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var q=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var Q=Object.prototype.hasOwnProperty;var _=(y,d)=>{for(var i in d)q(y,i,{get:d[i],enumerable:!0})},tt=(y,d,i,t)=>{if(d&&typeof d=="object"||typeof d=="function")for(let s of Z(d))!Q.call(y,s)&&s!==i&&q(y,s,{get:()=>d[s],enumerable:!(t=X(d,s))||t.enumerable});return y};var et=y=>tt(q({},"__esModule",{value:!0}),y);var it={};_(it,{RuleRegistry:()=>F,default:()=>J});module.exports=et(it);var Y=require("obsidian");var T=require("obsidian"),R=class extends T.PluginSettingTab{constructor(i,t){super(i,t);this.plugin=t}display(){let{containerEl:i}=this;i.empty(),new T.Setting(i).setName("\u8BED\u8A00 / Language").addDropdown(l=>l.addOption("zh","\u4E2D\u6587").addOption("en","English").setValue(this.plugin.settings.language||"zh").onChange(async n=>{this.plugin.settings.language=n,await this.plugin.saveSettings(),this.display()}));let t=this.plugin.settings.language==="en",s=t?"Knowledge Ark Diagnostic Center Settings":"\u77E5\u8BC6\u65B9\u821F\u8BCA\u65AD\u4E2D\u5FC3\u8BBE\u7F6E";i.createEl("h3",{text:s});let e=(l,n)=>t?n:l;new T.Setting(i).setName(e("\u5FC5\u586B\u5143\u6570\u636E\u5B57\u6BB5","Required Metadata Fields")).setDesc(e("\u8BF7\u8F93\u5165\u5FC5\u586B\u7684\u5143\u6570\u636E\u5B57\u6BB5\uFF0C\u7528\u9017\u53F7\u5206\u9694","Please enter the required metadata fields, separated by commas")).addText(l=>l.setPlaceholder("type,status,domain").setValue(this.plugin.settings.requiredMetadataFields.join(",")).onChange(async n=>{this.plugin.settings.requiredMetadataFields=n.split(",").map(a=>a.trim()).filter(a=>a.length>0),await this.plugin.saveSettings()})),new T.Setting(i).setName(e("\u6700\u5927\u7B14\u8BB0\u957F\u5EA6","Maximum Note Length")).setDesc(e("\u8D85\u8FC7\u6B64\u957F\u5EA6\u7684\u7B14\u8BB0\u5C06\u88AB\u6807\u8BB0\u4E3A\u95EE\u9898","Notes exceeding this length will be flagged as issues")).addText(l=>l.setPlaceholder("1500").setValue(this.plugin.settings.maxNoteLength.toString()).onChange(async n=>{let a=parseInt(n);isNaN(a)||(this.plugin.settings.maxNoteLength=a,await this.plugin.saveSettings())})),new T.Setting(i).setName(e("\u6700\u5C0F\u4E0A\u4E0B\u6587\u957F\u5EA6","Minimum Context Length")).setDesc(e("\u68C0\u67E5\u88F8\u94FE\u63A5\u65F6\u7684\u4E0A\u4E0B\u6587\u957F\u5EA6","Context length when checking naked links")).addText(l=>l.setPlaceholder("30").setValue(this.plugin.settings.minContextLength.toString()).onChange(async n=>{let a=parseInt(n);isNaN(a)||(this.plugin.settings.minContextLength=a,await this.plugin.saveSettings())})),new T.Setting(i).setName(e("\u6392\u9664\u6587\u4EF6\u5939","Excluded Folders")).setDesc(e("\u8BF7\u8F93\u5165\u8981\u6392\u9664\u7684\u6587\u4EF6\u5939\u8DEF\u5F84\uFF0C\u7528\u9017\u53F7\u5206\u9694","Please enter the folder paths to exclude, separated by commas")).addText(l=>l.setPlaceholder("templates,archive").setValue(this.plugin.settings.excludedFolders.join(",")).onChange(async n=>{this.plugin.settings.excludedFolders=n.split(",").map(a=>a.trim()).filter(a=>a.length>0),await this.plugin.saveSettings()})),new T.Setting(i).setName(e("\u6392\u9664\u6807\u7B7E","Excluded Tags")).setDesc(e("\u8BF7\u8F93\u5165\u8981\u6392\u9664\u7684\u6807\u7B7E(tags)\uFF0C\u7528\u9017\u53F7\u5206\u9694","Please enter the tags to exclude, separated by commas")).addText(l=>l.setPlaceholder("draft,template").setValue(this.plugin.settings.excludedTags.join(",")).onChange(async n=>{this.plugin.settings.excludedTags=n.split(",").map(a=>a.trim()).filter(a=>a.length>0),await this.plugin.saveSettings()})),new T.Setting(i).setName(e("\u77E5\u8BC6\u539F\u5B50\u7C7B\u578B","Knowledge Atom Types")).setDesc(e("\u8BF7\u8F93\u5165\u88AB\u89C6\u4E3A\u77E5\u8BC6\u539F\u5B50\u7684\u7B14\u8BB0\u7C7B\u578B(type)\uFF0C\u7528\u9017\u53F7\u5206\u9694","Please enter the note types (type) considered as knowledge atoms, separated by commas")).addText(l=>l.setPlaceholder("atom,concept,entity").setValue(this.plugin.settings.knowledgeAtomTypes.join(",")).onChange(async n=>{this.plugin.settings.knowledgeAtomTypes=n.split(",").map(a=>a.trim()).filter(a=>a.length>0),await this.plugin.saveSettings()})),new T.Setting(i).setName(e("\u8C13\u8BED\u4F7F\u7528\u9891\u7387\u9608\u503C","Predicate Usage Threshold")).setDesc(e("\u4F4E\u4E8E\u6B64\u4F7F\u7528\u6B21\u6570\u7684\u8C13\u8BED\u5C06\u88AB\u6807\u8BB0\u4E3A\u4F7F\u7528\u9891\u7387\u8FC7\u4F4E\uFF08\u8BBE\u4E3A0\u53EF\u7981\u7528\u6B64\u68C0\u67E5\uFF09","Predicates with usage count below this threshold will be flagged as low usage (set to 0 to disable this check)")).addText(l=>l.setPlaceholder("1").setValue(this.plugin.settings.predicateUsageThreshold.toString()).onChange(async n=>{let a=parseInt(n);!isNaN(a)&&a>=0&&(this.plugin.settings.predicateUsageThreshold=a,await this.plugin.saveSettings())})),new T.Setting(i).setName(e("\u5BFC\u51FA\u6A21\u677F","Export Template")).setDesc(e("\u8BBE\u7F6E\u5BFC\u51FAJSONL\u7684\u6A21\u677F","Set the template for exporting JSONL")).addTextArea(l=>{l.setPlaceholder('{"content": "{{content}}", "tags": "{{tags}}", "type": "{{type}}"}').setValue(this.plugin.settings.exportTemplate).onChange(async n=>{this.plugin.settings.exportTemplate=n,await this.plugin.saveSettings()}),l.inputEl.rows=4,l.inputEl.cols=50}),new T.Setting(i).setName(e("\u767D\u540D\u5355\u7BA1\u7406","Whitelist Management")).setDesc(e("\u4EE5\u4E0B\u95EE\u9898\u5DF2\u88AB\u6DFB\u52A0\u5230\u767D\u540D\u5355\u4E2D\uFF0C\u4E0D\u4F1A\u5728\u8BCA\u65AD\u4E2D\u663E\u793A\u3002","The following issues have been added to the whitelist and will not be displayed in the diagnosis."));let o=i.createEl("div",{cls:"knowledge-ark-ignored-issues"}),r=()=>{if(o.empty(),this.plugin.settings.ignoredIssues.length===0){o.createEl("p",{text:e("\u6682\u65E0\u88AB\u5FFD\u7565\u7684\u95EE\u9898\u3002","No ignored issues.")});return}let l=o.createEl("button",{text:e("\u5168\u90E8\u79FB\u9664","Remove All"),cls:"knowledge-ark-ignored-issue-button"});l.style.marginBottom="10px",l.onClickEvent(async()=>{this.plugin.settings.ignoredIssues=[],await this.plugin.saveSettings(),r()});let n=o.createEl("ul");this.plugin.settings.ignoredIssues.forEach((a,h)=>{let p=n.createEl("li",{cls:"knowledge-ark-ignored-issue-item"}),f=p.createEl("span",{text:a,cls:"knowledge-ark-ignored-issue-text"});p.createEl("button",{text:e("\u79FB\u9664","Remove"),cls:"knowledge-ark-ignored-issue-button"}).onClickEvent(async()=>{this.plugin.settings.ignoredIssues.splice(h,1),await this.plugin.saveSettings(),r()})})};r();let g=e("\u8BCA\u65AD\u89C4\u5219\u6743\u91CD\u914D\u7F6E","Diagnostic Rule Weights Configuration");i.createEl("h3",{text:g});let c=e("\u4E3A\u6BCF\u4E2A\u8BCA\u65AD\u89C4\u5219\u8BBE\u7F6E\u5355\u9879\u6263\u5206\u503C\u3002\u6263\u5206\u503C\u8D8A\u9AD8\uFF0C\u8BE5\u95EE\u9898\u5BF9\u5065\u5EB7\u5EA6\u603B\u5206\u7684\u5F71\u54CD\u8D8A\u5927\u3002","Set the penalty points for each diagnostic rule. Higher penalty points mean the issue will have a greater impact on the health score.");i.createEl("p",{text:c});let m=[{id:"metadata-integrity",name:e("\u5143\u6570\u636E\u5B8C\u6574\u6027\u68C0\u67E5","Metadata Integrity Check"),default:5},{id:"naked-links",name:e("\u88F8\u94FE\u63A5\u68C0\u67E5","Naked Links Check"),default:2},{id:"graph-connectivity",name:e("\u77E5\u8BC6\u56FE\u8C31\u8FDE\u63A5\u6027\u68C0\u67E5","Knowledge Graph Connectivity Check"),default:1},{id:"note-atomicity",name:e("\u7B14\u8BB0\u539F\u5B50\u5316\u7A0B\u5EA6\u68C0\u67E5","Note Atomicity Check"),default:.8},{id:"predicate-consistency",name:e("\u5173\u7CFB\u8C13\u8BED\u4E00\u81F4\u6027\u68C0\u67E5","Predicate Consistency Check"),default:.5},{id:"word-count-exceed",name:e("\u7B14\u8BB0\u957F\u5EA6\u8D85\u9650","Word Count Exceed"),default:.1}];for(let l of m){let n=this.plugin.settings.ruleWeights[l.id]!==void 0?this.plugin.settings.ruleWeights[l.id]:l.default;new T.Setting(i).setName(l.name).addText(a=>a.setPlaceholder(l.default.toString()).setValue(n.toString()).onChange(async h=>{let p=parseFloat(h);isNaN(p)||(this.plugin.settings.ruleWeights[l.id]=p,await this.plugin.saveSettings())}))}}};var H=require("obsidian");var G=require("obsidian"),D=class{constructor(d,i){this.plugin=d;this.app=i}async exportHealthyNotes(d){var m,l;let i=this.app.vault.getMarkdownFiles(),t=i.filter(n=>!d.some(a=>a.filePath===n.path));t=t.filter(n=>!this.plugin.settings.excludedFolders.some(a=>n.path.startsWith(a+"/")||n.path===a)),t=t.filter(n=>{let a=this.app.metadataCache.getFileCache(n);if(a&&a.frontmatter&&a.frontmatter.tags&&this.plugin.settings.excludedTags.length>0){let h=Array.isArray(a.frontmatter.tags)?a.frontmatter.tags:a.frontmatter.tags.split(",").map(u=>u.trim()),p=this.plugin.settings.excludedTags.map(u=>u.startsWith("#")?u.substring(1).toLowerCase():u.toLowerCase());return!h.map(u=>u.startsWith("#")?u.substring(1).toLowerCase():u.toLowerCase()).some(u=>p.includes(u))}return!0}),console.log("Excluded folders:",this.plugin.settings.excludedFolders),console.log("Excluded tags:",this.plugin.settings.excludedTags);let s=i.filter(n=>{if(!d.some(f=>f.filePath===n.path)||this.plugin.settings.excludedFolders.some(f=>n.path.startsWith(f+"/")||n.path===f))return!1;let p=this.app.metadataCache.getFileCache(n);if(p&&p.frontmatter&&p.frontmatter.tags&&this.plugin.settings.excludedTags.length>0){let f=Array.isArray(p.frontmatter.tags)?p.frontmatter.tags:p.frontmatter.tags.split(",").map(w=>w.trim()),u=this.plugin.settings.excludedTags.map(w=>w.startsWith("#")?w.substring(1).toLowerCase():w.toLowerCase());if(f.map(w=>w.startsWith("#")?w.substring(1).toLowerCase():w.toLowerCase()).some(w=>u.includes(w)))return!1}return!0});new G.Notice(`\u5BFC\u51FA ${t.length} \u4E2A\u5065\u5EB7\u7B14\u8BB0\uFF0C${s.length} \u4E2A\u7B14\u8BB0\u6709\u95EE\u9898\u3002`);let e=[];for(let n of t){if(this.plugin.settings.excludedFolders.some(u=>n.path.startsWith(u+"/")||n.path===u))continue;let a=this.app.metadataCache.getFileCache(n);if(a&&a.frontmatter&&a.frontmatter.tags&&this.plugin.settings.excludedTags.length>0){let u=Array.isArray(a.frontmatter.tags)?a.frontmatter.tags:a.frontmatter.tags.split(",").map(w=>w.trim()),k=this.plugin.settings.excludedTags.map(w=>w.startsWith("#")?w.substring(1).toLowerCase():w.toLowerCase());if(u.map(w=>w.startsWith("#")?w.substring(1).toLowerCase():w.toLowerCase()).some(w=>k.includes(w)))continue}let h=await this.app.vault.read(n),p={},f=this.plugin.settings.exportTemplate.replace("{{content}}",JSON.stringify(h)).replace("{{tags}}",JSON.stringify(((m=a==null?void 0:a.tags)==null?void 0:m.map(u=>u.tag).join(", "))||"")).replace("{{type}}",JSON.stringify(((l=a==null?void 0:a.frontmatter)==null?void 0:l.type)||"")).replace("{{fileName}}",JSON.stringify(n.name)).replace("{{filePath}}",JSON.stringify(n.path)).replace("{{frontmatter}}",JSON.stringify((a==null?void 0:a.frontmatter)||{})).replace("{{links}}",JSON.stringify((a==null?void 0:a.links)||[])).replace("{{headings}}",JSON.stringify((a==null?void 0:a.headings)||[]));try{let u=JSON.parse(f);e.push(JSON.stringify(u)),console.log(`Successfully parsed template for file ${n.path}`)}catch(u){console.error(`Error parsing template for file ${n.path}:`,u),console.error(`Template content: ${f}`)}}let o=e.join(`
`),r=new Blob([o],{type:"application/jsonl"}),g=URL.createObjectURL(r),c=document.createElement("a");c.href=g,c.download="knowledge-ark-export.jsonl",document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(g)}};var st=()=>{let y="knowledge-ark-health-score-styles";if(document.getElementById(y))return;let d=document.createElement("style");d.id=y,d.textContent=`
    .knowledge-ark-score.score-healthy {
      color: #28a745 !important; /* Green */
      font-size: 1.2em !important;
      font-weight: bold !important;
    }
    
    .knowledge-ark-score.score-warning {
      color: #ffc107 !important; /* Yellow */
      font-size: 1.2em !important;
      font-weight: bold !important;
    }
    
    .knowledge-ark-score.score-critical {
      color: #dc3545 !important; /* Red */
      font-size: 1.2em !important;
      font-weight: bold !important;
    }
  `,document.head.appendChild(d)};st();var S="knowledge-ark-view",z=class extends H.ItemView{constructor(i,t){super(i);this.plugin=t}getViewType(){return S}getDisplayText(){return this.plugin.settings.language==="en"?"Knowledge Ark Diagnostic Center":"\u77E5\u8BC6\u65B9\u821F\u8BCA\u65AD\u4E2D\u5FC3"}getIcon(){return"lucide-compass"}async onOpen(){let i=this.containerEl.children[1],t=this.plugin.settings.language==="en";i.empty(),i.createEl("h2",{text:t?"Knowledge Ark Diagnostic Center":"\u77E5\u8BC6\u65B9\u821F\u8BCA\u65AD\u4E2D\u5FC3"});let s=i.createEl("div",{cls:"knowledge-ark-header"}),e=s.createEl("button",{text:t?"Start Full Diagnosis":"\u5F00\u59CB\u5168\u9762\u8BCA\u65AD",cls:"knowledge-ark-button primary"}),o=s.createEl("button",{text:t?"Start Incremental Diagnosis":"\u65B0\u589E\u7B14\u8BB0\u8BCA\u65AD",cls:"knowledge-ark-button primary"}),r=s.createEl("button",{text:t?"Export Healthy Notes":"\u5BFC\u51FA\u5065\u5EB7\u7B14\u8BB0",cls:"knowledge-ark-button secondary"}),g=s.createEl("div",{cls:"knowledge-ark-metrics"}),c=g.createEl("div",{text:t?"Health Score: --%":"\u5065\u5EB7\u5EA6\u603B\u5206: --%",cls:"knowledge-ark-score"}),m=g.createEl("div",{text:t?"Knowledge Atom Stats: --":"\u77E5\u8BC6\u539F\u5B50\u7EDF\u8BA1: --",cls:"knowledge-ark-atom-count"}),l=g.createEl("div",{text:t?"Connection Density: --":"\u8FDE\u63A5\u5BC6\u5EA6: --",cls:"knowledge-ark-connection-density"}),n=i.createEl("div",{cls:"knowledge-ark-results"}),a=this.plugin.settings.savedDiagnosisResults;if(a)c.setText(t?`Health Score: ${a.healthScore}%`:`\u5065\u5EB7\u5EA6\u603B\u5206: ${a.healthScore}%`),c.className=`knowledge-ark-score ${this.getScoreClass(a.healthScore)}`,m.setText(t?`Knowledge Atom Stats: ${a.atomCount}`:`\u77E5\u8BC6\u539F\u5B50\u7EDF\u8BA1: ${a.atomCount}`),l.setText(t?`Connection Density: ${a.connectionDensity}`:`\u8FDE\u63A5\u5BC6\u5EA6: ${a.connectionDensity}`),n.empty(),a.issues.length===0?n.createEl("p",{text:t?"Congratulations! Your knowledge base is very healthy.":"\u606D\u559C\uFF01\u60A8\u7684\u77E5\u8BC6\u5E93\u975E\u5E38\u5065\u5EB7\u3002",cls:"knowledge-ark-placeholder"}):(this.renderDiagnosticCards(n,a.issues),await this.renderHealthyNotes(n));else{let h=n.createEl("p",{text:t?'Click "Start Full Diagnosis" to analyze your knowledge ark':'\u70B9\u51FB"\u5F00\u59CB\u5168\u9762\u8BCA\u65AD"\u4EE5\u5206\u6790\u60A8\u7684\u77E5\u8BC6\u65B9\u821F',cls:"knowledge-ark-placeholder"})}l.addEventListener("mouseenter",h=>{let f=this.calculateConnectionDensity().match(/\[↑ ([0-9.]+)\] \[↓ ([0-9.]+)\]/),u="0",k="0";f&&f.length===3&&(u=f[1],k=f[2]);let v=document.createElement("div");v.className="knowledge-ark-tooltip",v.textContent=t?`Each note is referenced by an average of ${u} other notes / Each note references an average of ${k} other notes`:`\u5E73\u5747\u6BCF\u4E2A\u7B14\u8BB0\u88AB${u}\u4E2A\u5176\u4ED6\u7B14\u8BB0\u6240\u5F15\u7528 / \u5E73\u5747\u6BCF\u4E2A\u7B14\u8BB0\u5F15\u7528\u4E86${k}\u4E2A\u5176\u4ED6\u7B14\u8BB0`,v.style.position="absolute",v.style.left=`${h.pageX}px`,v.style.top=`${h.pageY-30}px`,document.body.appendChild(v)}),l.addEventListener("mouseleave",()=>{document.querySelectorAll(".knowledge-ark-tooltip").forEach(p=>p.remove())}),e.onClickEvent(async()=>{e.setText(t?"Diagnosing...":"\u8BCA\u65AD\u4E2D..."),e.disabled=!0;let h=await this.plugin.runDiagnostics(),p=this.calculateHealthScore(h);c.setText(t?`Health Score: ${p}%`:`\u5065\u5EB7\u5EA6\u603B\u5206: ${p}%`),c.className=`knowledge-ark-score ${this.getScoreClass(p)}`;let f=this.calculateAtomCount();m.setText(t?`Knowledge Atom Stats: ${f}`:`\u77E5\u8BC6\u539F\u5B50\u7EDF\u8BA1: ${f}`);let u=this.calculateConnectionDensity();l.setText(t?`Connection Density: ${u}`:`\u8FDE\u63A5\u5BC6\u5EA6: ${u}`),this.plugin.settings.savedDiagnosisResults={issues:h,healthScore:p,atomCount:f,connectionDensity:u,diagnosisTime:Date.now()},await this.plugin.saveSettings(),n.empty(),h.length===0?n.createEl("p",{text:t?"Congratulations! Your knowledge base is very healthy.":"\u606D\u559C\uFF01\u60A8\u7684\u77E5\u8BC6\u5E93\u975E\u5E38\u5065\u5EB7\u3002",cls:"knowledge-ark-placeholder"}):(this.renderDiagnosticCards(n,h),await this.renderHealthyNotes(n)),e.setText(t?"Start Full Diagnosis":"\u5F00\u59CB\u5168\u9762\u8BCA\u65AD"),e.disabled=!1}),o.onClickEvent(async()=>{o.setText(t?"Diagnosing...":"\u8BCA\u65AD\u4E2D..."),o.disabled=!0;let h=await this.plugin.runDiagnostics(!0),p=h;if(this.plugin.settings.savedDiagnosisResults){let v=new Set(this.app.vault.getMarkdownFiles().map(C=>C.path)),w=this.plugin.settings.savedDiagnosisResults.issues.filter(C=>v.has(C.filePath)),P=new Set(w.map(C=>C.id)),A=h.filter(C=>!P.has(C.id));p=[...w,...A]}let f=this.calculateHealthScore(p);c.setText(t?`Health Score: ${f}%`:`\u5065\u5EB7\u5EA6\u603B\u5206: ${f}%`),c.className=`knowledge-ark-score ${this.getScoreClass(f)}`;let u=this.calculateAtomCount();m.setText(t?`Knowledge Atom Stats: ${u}`:`\u77E5\u8BC6\u539F\u5B50\u7EDF\u8BA1: ${u}`);let k=this.calculateConnectionDensity();l.setText(t?`Connection Density: ${k}`:`\u8FDE\u63A5\u5BC6\u5EA6: ${k}`),this.plugin.settings.savedDiagnosisResults={issues:p,healthScore:f,atomCount:u,connectionDensity:k,diagnosisTime:Date.now()},await this.plugin.saveSettings(),n.empty(),p.length===0?n.createEl("p",{text:t?"Congratulations! Your knowledge base is very healthy.":"\u606D\u559C\uFF01\u60A8\u7684\u77E5\u8BC6\u5E93\u975E\u5E38\u5065\u5EB7\u3002",cls:"knowledge-ark-placeholder"}):(this.renderDiagnosticCards(n,p),await this.renderHealthyNotes(n)),o.setText(t?"Start Incremental Diagnosis":"\u65B0\u589E\u7B14\u8BB0\u8BCA\u65AD"),o.disabled=!1}),r.onClickEvent(async()=>{r.setText(t?"Exporting...":"\u5BFC\u51FA\u4E2D..."),r.disabled=!0;let h=await this.plugin.runDiagnostics();await this.plugin.exportHealthyNotes(h),r.setText(t?"Export Healthy Notes":"\u5BFC\u51FA\u5065\u5EB7\u7B14\u8BB0"),r.disabled=!1})}calculateHealthScore(i){let t=i.filter(r=>!this.plugin.settings.ignoredIssues.includes(r.id)),s=0,e={};for(let r of t)e[r.ruleId]||(e[r.ruleId]=0),e[r.ruleId]++;for(let[r,g]of Object.entries(e)){let c=this.plugin.settings.ruleWeights[r]||0;s+=g*c}let o=Math.max(0,100-s);return Math.round(o)}getScoreClass(i){return i>=90?"score-healthy":i>=70?"score-warning":"score-critical"}renderDiagnosticCards(i,t){let s=this.plugin.settings.language==="en",e=t.filter(r=>!this.plugin.settings.ignoredIssues.includes(r.id)),o={};for(let r of e)o[r.ruleId]||(o[r.ruleId]=[]),o[r.ruleId].push(r);for(let[r,g]of Object.entries(o)){let c=i.createEl("div",{cls:"knowledge-ark-card"}),m=c.createEl("div",{cls:"knowledge-ark-card-header"}),l=m.createEl("div",{cls:"knowledge-ark-card-title-container"}),n=l.createEl("div",{cls:"knowledge-ark-card-title"}),a=g[0].ruleId,h=s?"Issue Description":"\u95EE\u9898\u63CF\u8FF0",p=s?{"metadata-integrity":{name:"Metadata Integrity Check",description:"Check if note files contain standard YAML Frontmatter"},"note-atomicity":{name:"Note Atomicity Check",description:"Check if notes are too lengthy or have scattered topics"},"naked-links":{name:"Naked Links Check",description:"Check if internal links lack sufficient context"},"graph-connectivity":{name:"Knowledge Graph Connectivity Check",description:'Check for unconnected "information islands"'},"predicate-consistency":{name:"Predicate Consistency Check",description:"Encourage the standard use of `key:: [[Link]]`"}}:{"metadata-integrity":{name:"\u5143\u6570\u636E\u5B8C\u6574\u6027\u68C0\u67E5",description:"\u68C0\u67E5\u7B14\u8BB0\u6587\u4EF6\u662F\u5426\u5305\u542B\u89C4\u8303\u7684YAML Frontmatter"},"note-atomicity":{name:"\u7B14\u8BB0\u539F\u5B50\u5316\u7A0B\u5EA6\u68C0\u67E5",description:"\u68C0\u67E5\u7B14\u8BB0\u662F\u5426\u8FC7\u4E8E\u5197\u957F\u6216\u4E3B\u9898\u5206\u6563"},"naked-links":{name:"\u88F8\u94FE\u63A5\u68C0\u67E5",description:"\u68C0\u67E5\u5185\u90E8\u94FE\u63A5\u662F\u5426\u7F3A\u5C11\u8DB3\u591F\u7684\u4E0A\u4E0B\u6587"},"graph-connectivity":{name:"\u77E5\u8BC6\u56FE\u8C31\u8FDE\u63A5\u6027\u68C0\u67E5",description:'\u68C0\u67E5\u662F\u5426\u5B58\u5728\u672A\u88AB\u8FDE\u63A5\u7684"\u4FE1\u606F\u5B64\u5C9B"'},"predicate-consistency":{name:"\u5173\u7CFB\u8C13\u8BED\u4E00\u81F4\u6027\u68C0\u67E5",description:"\u9F13\u52B1`key:: [[Link]]`\u7684\u89C4\u8303\u4F7F\u7528"}};p[r]&&(a=p[r].name,h=p[r].description),n.createEl("span",{text:`\u26A0\uFE0F ${a}`}),l.createEl("div",{text:h,cls:"knowledge-ark-card-description"});let f=m.createEl("div",{cls:"knowledge-ark-badge-toggle-container"});f.createEl("span",{text:g.length.toString(),cls:"knowledge-ark-card-badge"});let u=f.createEl("button",{cls:"knowledge-ark-card-toggle"}),k='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>',v='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>';u.innerHTML=k;let w=c.createEl("div",{cls:"knowledge-ark-card-content"});w.hide();let P=w.createEl("table",{cls:"knowledge-ark-issue-table"}),C=P.createEl("thead").createEl("tr");C.createEl("th",{text:s?"File Name":"\u6587\u4EF6\u540D"}),C.createEl("th",{text:s?"Context Preview":"\u4E0A\u4E0B\u6587\u9884\u89C8"}),C.createEl("th",{text:s?"Actions":"\u64CD\u4F5C"});let N=P.createEl("tbody");for(let x of g){let I=N.createEl("tr");I.createEl("td").createEl("a",{text:x.fileName,href:"#"}).onClickEvent(W=>{W.preventDefault(),this.navigateToIssue(x.filePath,x.position)}),I.createEl("td",{text:x.contextPreview,cls:"knowledge-ark-issue-context"});let L=I.createEl("td",{cls:"knowledge-ark-issue-actions"});L.createEl("button",{text:s?"Jump":"\u8DF3\u8F6C",cls:"knowledge-ark-issue-button"}).onClickEvent(()=>{this.navigateToIssue(x.filePath,x.position)});let E=L.createEl("button",{text:s?"Ignore":"\u5FFD\u7565",cls:"knowledge-ark-issue-button"});if(E.onClickEvent(()=>{this.ignoreIssue(x.id),I.remove()}),this.plugin.settings.ignoredIssues.includes(x.id)){let W=L.createEl("button",{text:s?"Unignore":"\u53D6\u6D88\u5FFD\u7565",cls:"knowledge-ark-issue-button"});W.onClickEvent(()=>{this.unignoreIssue(x.id),E.setText("\u5FFD\u7565"),W.remove()})}}let b=()=>{w.isShown()?(w.hide(),u.innerHTML=k):(w.show(),u.innerHTML=v)};u.onClickEvent(x=>{x.stopPropagation(),b()}),m.onClickEvent(b)}}async renderHealthyNotes(i){var C,N;let t=this.plugin.settings.language==="en",s=i.createEl("div",{cls:"knowledge-ark-healthy-notes-section"}),e=s.createEl("div",{cls:"knowledge-ark-card-header"}),r=e.createEl("div",{cls:"knowledge-ark-card-title-container"}).createEl("div",{cls:"knowledge-ark-card-title"});r.createEl("span",{text:"\u2705 "}),r.createEl("span",{text:t?"Healthy Notes List":"\u5065\u5EB7\u7B14\u8BB0\u5217\u8868"});let g=await this.plugin.runDiagnostics(),c=new D(this.plugin,this.app),n=this.app.vault.getMarkdownFiles().filter(b=>{let x=this.plugin.settings.excludedFolders.some(L=>b.path.startsWith(L+"/")),I=this.app.metadataCache.getFileCache(b),M=[];I&&I.frontmatter&&I.frontmatter.tags&&(M=Array.isArray(I.frontmatter.tags)?I.frontmatter.tags:I.frontmatter.tags.split(",").map(L=>L.trim()));let $=this.plugin.settings.excludedTags.length>0&&(()=>{let L=this.plugin.settings.excludedTags.map(E=>E.startsWith("#")?E.substring(1).toLowerCase():E.toLowerCase());return M.map(E=>E.startsWith("#")?E.substring(1).toLowerCase():E.toLowerCase()).some(E=>L.includes(E))})();return!x&&!$}).filter(b=>!g.some(x=>x.filePath===b.path)),a=e.createEl("div",{cls:"knowledge-ark-badge-toggle-container"});a.createEl("span",{text:n.length.toString(),cls:"knowledge-ark-card-badge"});let h=a.createEl("button",{cls:"knowledge-ark-card-toggle"}),p='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>',f='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>';h.innerHTML=p;let u=s.createEl("div",{cls:"knowledge-ark-card-content"});u.hide(),r.createEl("span",{text:"\u2705 "}),r.createEl("span",{text:t?"Healthy Notes List":"\u5065\u5EB7\u7B14\u8BB0\u5217\u8868"});let k=u.createEl("table",{cls:"knowledge-ark-issue-table"}),w=k.createEl("thead").createEl("tr");w.createEl("th",{text:t?"File Name":"\u6587\u4EF6\u540D"}),w.createEl("th",{text:t?"Tags":"\u6807\u7B7E"}),w.createEl("th",{text:t?"Type":"\u7C7B\u578B"});let P=k.createEl("tbody");for(let b of n){let x=P.createEl("tr");x.createEl("td").createEl("a",{text:b.name,href:"#"}).onClickEvent(E=>{E.preventDefault(),this.app.workspace.getLeaf(!0).openFile(b)});let $=this.app.metadataCache.getFileCache(b),L=((C=$==null?void 0:$.tags)==null?void 0:C.map(E=>E.tag).join(", "))||"",U=((N=$==null?void 0:$.frontmatter)==null?void 0:N.type)||"";x.createEl("td",{text:L}),x.createEl("td",{text:U})}let A=()=>{u.isShown()?(u.hide(),h.innerHTML=p):(u.show(),h.innerHTML=f)};h.onClickEvent(b=>{b.stopPropagation(),A()}),e.onClickEvent(A)}calculateAtomCount(){var s;let i=this.app.vault.getMarkdownFiles(),t=0;for(let e of i){let o=this.app.metadataCache.getFileCache(e),r=(s=o==null?void 0:o.frontmatter)==null?void 0:s.type;r&&this.plugin.settings.knowledgeAtomTypes.includes(r)&&t++}return t}calculateConnectionDensity(){var m;let i=this.app.vault.getMarkdownFiles(),t=i.filter(l=>{let n=this.plugin.settings.excludedFolders.some(f=>l.path.startsWith(f+"/")),a=this.app.metadataCache.getFileCache(l),h=[];a&&a.frontmatter&&a.frontmatter.tags&&(h=Array.isArray(a.frontmatter.tags)?a.frontmatter.tags:a.frontmatter.tags.split(",").map(f=>f.trim()));let p=this.plugin.settings.excludedTags.length>0&&(()=>{let f=this.plugin.settings.excludedTags.map(k=>k.startsWith("#")?k.substring(1).toLowerCase():k.toLowerCase());return h.map(k=>k.startsWith("#")?k.substring(1).toLowerCase():k.toLowerCase()).some(k=>f.includes(k))})();return!n&&!p}),s=t.length;if(s===0)return"[\u2191 0] [\u2193 0]";let e=0,o=0,r=this.app.metadataCache.resolvedLinks;for(let l of t){let n=r[l.path]?Object.values(r[l.path]).reduce((h,p)=>h+p,0):0;o+=n;let a=0;for(let h in r){let p=i.find(f=>f.path===h);if(p){let f=this.app.metadataCache.getFileCache(p),u=((m=f==null?void 0:f.tags)==null?void 0:m.map(w=>w.tag))||[],k=this.plugin.settings.excludedFolders.some(w=>p.path.startsWith(w+"/")),v=this.plugin.settings.excludedTags.some(w=>u.includes("#"+w));!k&&!v&&r[h][l.path]&&(a+=r[h][l.path])}}e+=a}let g=(e/s).toFixed(1),c=(o/s).toFixed(1);return`[\u2191 ${g}] [\u2193 ${c}]`}async navigateToIssue(i,t){let s=this.app.vault.getAbstractFileByPath(i);if(s){let e=this.app.workspace.getLeaf(!0);await e.openFile(s);let o=e.view instanceof H.MarkdownView?e.view.editor:null;if(o){let r=o.offsetToPos(t.start);o.setCursor(r),o.scrollIntoView({from:r,to:r},!0)}}else console.error(`File not found: ${i}`)}ignoreIssue(i){this.plugin.settings.ignoredIssues.includes(i)||(this.plugin.settings.ignoredIssues.push(i),this.plugin.saveSettings())}unignoreIssue(i){let t=this.plugin.settings.ignoredIssues.indexOf(i);t>-1&&(this.plugin.settings.ignoredIssues.splice(t,1),this.plugin.saveSettings())}async onClose(){}};var K=class{constructor(d,i){this.plugin=d;this.app=i;this.id="metadata-integrity";this.name="\u5143\u6570\u636E\u5B8C\u6574\u6027\u68C0\u67E5";this.description="\u68C0\u67E5\u7B14\u8BB0\u6587\u4EF6\u662F\u5426\u5305\u542B\u89C4\u8303\u7684YAML Frontmatter"}async check(){let d=[],i=this.app.vault.getMarkdownFiles();for(let t of i){if(this.plugin.settings.excludedFolders.some(o=>t.path.startsWith(o)))continue;let s=this.app.metadataCache.getFileCache(t);if(s&&s.frontmatter&&s.frontmatter.tags&&this.plugin.settings.excludedTags.length>0){let o=Array.isArray(s.frontmatter.tags)?s.frontmatter.tags:s.frontmatter.tags.split(",").map(c=>c.trim()),r=this.plugin.settings.excludedTags.map(c=>c.startsWith("#")?c.substring(1).toLowerCase():c.toLowerCase());if(o.map(c=>c.startsWith("#")?c.substring(1).toLowerCase():c.toLowerCase()).some(c=>r.includes(c)))continue}if(!s||!s.frontmatter){d.push({id:`${this.id}-${t.path}`,ruleId:this.id,filePath:t.path,fileName:t.name,contextPreview:this.plugin.settings.language==="en"?"Missing YAML Frontmatter":"\u7F3A\u5C11YAML Frontmatter",position:{start:0,end:0},severity:"high",isIgnored:this.plugin.settings.ignoredIssues.includes(`${this.id}-${t.path}`)});continue}let e=[];for(let o of this.plugin.settings.requiredMetadataFields)o in s.frontmatter||e.push(o);e.length>0&&d.push({id:`${this.id}-${t.path}`,ruleId:this.id,filePath:t.path,fileName:t.name,contextPreview:this.plugin.settings.language==="en"?`Missing required fields: ${e.join(", ")}`:`\u7F3A\u5C11\u5FC5\u586B\u5B57\u6BB5: ${e.join(", ")}`,position:{start:0,end:0},severity:"medium",isIgnored:this.plugin.settings.ignoredIssues.includes(`${this.id}-${t.path}`)})}return d}},j=class{constructor(d,i){this.plugin=d;this.app=i;this.id="note-atomicity";this.name="\u7B14\u8BB0\u539F\u5B50\u5316\u7A0B\u5EA6\u68C0\u67E5";this.description="\u68C0\u67E5\u7B14\u8BB0\u662F\u5426\u8FC7\u4E8E\u5197\u957F\u6216\u4E3B\u9898\u5206\u6563"}async check(){let d=[],i=this.app.vault.getMarkdownFiles();for(let t of i){if(this.plugin.settings.excludedFolders.some(c=>t.path.startsWith(c)))continue;let s=this.app.metadataCache.getFileCache(t);if(s&&s.frontmatter&&s.frontmatter.tags&&this.plugin.settings.excludedTags.length>0){let c=Array.isArray(s.frontmatter.tags)?s.frontmatter.tags:s.frontmatter.tags.split(",").map(n=>n.trim()),m=this.plugin.settings.excludedTags.map(n=>n.startsWith("#")?n.substring(1).toLowerCase():n.toLowerCase());if(c.map(n=>n.startsWith("#")?n.substring(1).toLowerCase():n.toLowerCase()).some(n=>m.includes(n)))continue}let e=await this.app.vault.read(t);e.length>this.plugin.settings.maxNoteLength&&d.push({id:`${this.id}-${t.path}`,ruleId:this.id,filePath:t.path,fileName:t.name,contextPreview:this.plugin.settings.language==="en"?`Note length (${e.length}) exceeds threshold (${this.plugin.settings.maxNoteLength})`:`\u7B14\u8BB0\u957F\u5EA6 (${e.length}) \u8D85\u8FC7\u9608\u503C (${this.plugin.settings.maxNoteLength})`,position:{start:0,end:0},severity:"medium",isIgnored:this.plugin.settings.ignoredIssues.includes(`${this.id}-${t.path}`)});let o=e.replace(/```[\s\S]*?```/g,"").replace(/```[\s\S]*$/g,"");o=o.replace(/`[^`]*`/g,""),o=o.replace(/---[\s\S]*?---/,"");let r=(o.match(/^#\s/gm)||[]).length,g=(o.match(/^##\s/gm)||[]).length;r>1?d.push({id:`${this.id}-${t.path}-h1`,ruleId:this.id,filePath:t.path,fileName:t.name,contextPreview:this.plugin.settings.language==="en"?`Found ${r} H1 headers and ${g} H2 headers`:`\u53D1\u73B0 ${r} \u4E2AH1\u6807\u9898\uFF0C${g} \u4E2AH2\u6807\u9898`,position:{start:0,end:0},severity:"medium",isIgnored:this.plugin.settings.ignoredIssues.includes(`${this.id}-${t.path}-h1`)}):g>=5&&d.push({id:`${this.id}-${t.path}-h2`,ruleId:this.id,filePath:t.path,fileName:t.name,contextPreview:this.plugin.settings.language==="en"?`Found ${g} H2 headers, consider splitting the note`:`\u53D1\u73B0 ${g} \u4E2AH2\u6807\u9898\uFF0C\u5EFA\u8BAE\u8003\u8651\u62C6\u5206\u7B14\u8BB0`,position:{start:0,end:0},severity:"low",isIgnored:this.plugin.settings.ignoredIssues.includes(`${this.id}-${t.path}-h2`)})}return d}},O=class{constructor(d,i){this.plugin=d;this.app=i;this.id="naked-links";this.name="\u88F8\u94FE\u63A5\u68C0\u67E5";this.description="\u68C0\u67E5\u5185\u90E8\u94FE\u63A5\u662F\u5426\u7F3A\u5C11\u8DB3\u591F\u7684\u4E0A\u4E0B\u6587"}async check(){let d=[],i=this.app.vault.getMarkdownFiles();for(let t of i){if(this.plugin.settings.excludedFolders.some(r=>t.path.startsWith(r)))continue;let s=this.app.metadataCache.getFileCache(t);if(s&&s.frontmatter&&s.frontmatter.tags&&this.plugin.settings.excludedTags.length>0){let r=Array.isArray(s.frontmatter.tags)?s.frontmatter.tags:s.frontmatter.tags.split(",").map(m=>m.trim()),g=this.plugin.settings.excludedTags.map(m=>m.startsWith("#")?m.substring(1).toLowerCase():m.toLowerCase());if(r.map(m=>m.startsWith("#")?m.substring(1).toLowerCase():m.toLowerCase()).some(m=>g.includes(m)))continue}let e=await this.app.vault.read(t),o=this.app.metadataCache.getFileCache(t);if(!(!o||!o.links))for(let r of o.links){if(r.link.startsWith("http"))continue;let g=r.position.start.offset,c=r.position.end.offset,m=Math.max(0,g-this.plugin.settings.minContextLength),l=Math.min(e.length,c+this.plugin.settings.minContextLength),n=e.substring(m,l),a=r.displayText||r.link,h=/[\u4e00-\u9fa5a-zA-Z0-9]{2,}/.test(a),p=/[\u4e00-\u9fa5]/.test(n),f=/(总结|说明|参考|详见|见|关于|介绍|讨论|分析|描述|解释|定义|提供|展示|记录|表示|指出|强调|认为|觉得|发现|::|关联|连接|影响|导致|促进|抑制|包含|组成|构成|体现|代表|象征|反映|支持|反对|依赖|源于|归因于|属于|作用于|适用于|应用于|产生|形成|达成|实现|发展|演变|转化|转变|影响|引发|基于|遵循|符合|符合于|来源于|揭示|证明|阐述|涉及|涵盖|包括|意味着|预示|对比|承载|运用|构建|分类于|区别于|平行于|解决|处理|整合|优化|简化|relate|connect|affect|cause|promote|inhibit|contain|compose|constitute|embody|represent|symbolize|reflect|support|oppose|depend|derive|attribute|belong|act|apply|produce|form|develop|evolve|transform|trigger|base|follow|comply|source|reveal|prove|explain|involve|cover|include|mean|predict|contrast|carry|use|build|classify|distinguish|parallel|solve|handle|integrate|optimize|simplify)/,u=e.substring(m,g),k=e.substring(c,l),v=u+k,w=f.test(v),P=/\[\[[^\]]+\|[^\]]+\]\]/.test(e.substring(g-10,c+10))||/\[[^\]]+\]\([^)]+\)/.test(e.substring(g-10,c+10));!w&&!P&&d.push({id:`${this.id}-${t.path}-${g}`,ruleId:this.id,filePath:t.path,fileName:t.name,contextPreview:(this.plugin.settings.language==="en",n),position:{start:g,end:c},severity:"low",isIgnored:this.plugin.settings.ignoredIssues.includes(`${this.id}-${t.path}-${g}`)})}}return d}},B=class{constructor(d,i){this.plugin=d;this.app=i;this.id="graph-connectivity";this.name="\u77E5\u8BC6\u56FE\u8C31\u8FDE\u63A5\u6027\u68C0\u67E5";this.description='\u68C0\u67E5\u662F\u5426\u5B58\u5728\u672A\u88AB\u8FDE\u63A5\u7684"\u4FE1\u606F\u5B64\u5C9B"'}async check(){let d=[],i=this.app.vault.getMarkdownFiles(),t=new Map;for(let s of i){if(this.plugin.settings.excludedFolders.some(o=>s.path.startsWith(o)))continue;let e=this.app.metadataCache.getFileCache(s);if(e&&e.frontmatter&&e.frontmatter.tags&&this.plugin.settings.excludedTags.length>0){let o=Array.isArray(e.frontmatter.tags)?e.frontmatter.tags:e.frontmatter.tags.split(",").map(c=>c.trim()),r=this.plugin.settings.excludedTags.map(c=>c.startsWith("#")?c.substring(1).toLowerCase():c.toLowerCase());if(o.map(c=>c.startsWith("#")?c.substring(1).toLowerCase():c.toLowerCase()).some(c=>r.includes(c)))continue}if(t.has(s.path)||t.set(s.path,{inbound:0,outbound:0}),e&&e.links){t.get(s.path).outbound+=e.links.length;for(let o of e.links)if(!o.link.startsWith("http")){let r=this.resolveLinkPath(s.path,o.link);r&&(t.has(r)||t.set(r,{inbound:0,outbound:0}),t.get(r).inbound+=1)}}}for(let[s,e]of t.entries()){let o=this.app.vault.getAbstractFileByPath(s);o&&(this.plugin.settings.excludedFolders.some(r=>o.path.startsWith(r))||(e.inbound===0&&e.outbound===0&&d.push({id:`${this.id}-${s}-isolated`,ruleId:this.id,filePath:s,fileName:o.name,contextPreview:this.plugin.settings.language==="en"?"Isolated node (inbound=0 and outbound=0)":"\u4FE1\u606F\u5B64\u5C9B\u8282\u70B9 (\u5165\u94FE=0 \u4E14 \u51FA\u94FE=0)",position:{start:0,end:0},severity:"medium",isIgnored:this.plugin.settings.ignoredIssues.includes(`${this.id}-${s}-isolated`)}),e.outbound===0&&e.inbound>0&&d.push({id:`${this.id}-${s}-leaf`,ruleId:this.id,filePath:s,fileName:o.name,contextPreview:this.plugin.settings.language==="en"?"Leaf node (outbound=0 but inbound>0)":"\u7EC8\u70B9\u8282\u70B9 (\u51FA\u94FE=0 \u4F46 \u5165\u94FE>0)",position:{start:0,end:0},severity:"low",isIgnored:this.plugin.settings.ignoredIssues.includes(`${this.id}-${s}-leaf`)})))}return d}resolveLinkPath(d,i){return`${d.substring(0,d.lastIndexOf("/"))}/${i}.md`}},V=class{constructor(d,i){this.plugin=d;this.app=i;this.id="predicate-consistency";this.name="\u5173\u7CFB\u8C13\u8BED\u4E00\u81F4\u6027\u68C0\u67E5";this.description="\u9F13\u52B1`key:: [[Link]]`\u7684\u89C4\u8303\u4F7F\u7528"}async check(){let d=[],i=this.app.vault.getMarkdownFiles(),t=new Map;for(let s of i){if(this.plugin.settings.excludedFolders.some(c=>s.path.startsWith(c)))continue;let e=this.app.metadataCache.getFileCache(s);if(e&&e.frontmatter&&e.frontmatter.tags&&this.plugin.settings.excludedTags.length>0){let c=Array.isArray(e.frontmatter.tags)?e.frontmatter.tags:e.frontmatter.tags.split(",").map(n=>n.trim()),m=this.plugin.settings.excludedTags.map(n=>n.startsWith("#")?n.substring(1).toLowerCase():n.toLowerCase());if(c.map(n=>n.startsWith("#")?n.substring(1).toLowerCase():n.toLowerCase()).some(n=>m.includes(n)))continue}let o=await this.app.vault.read(s),r=/([\u4e00-\u9fa5\w-]+)::/g,g;for(;(g=r.exec(o))!==null;){let c=g[1],m={start:g.index,end:g.index+g[0].length},l=Math.max(0,m.start-50),n=Math.min(o.length,m.end+50),a=o.substring(l,n);t.has(c)||t.set(c,{count:0,locations:[]});let h=t.get(c);h.count++,h.locations.push({filePath:s.path,fileName:s.name,position:m,contextPreview:a})}}for(let[s,e]of t.entries()){let o=this.plugin.settings.predicateUsageThreshold||1;if(e.count<o)for(let g of e.locations)d.push({id:`${this.id}-${s}-${g.filePath}-${g.position.start}`,ruleId:this.id,filePath:g.filePath,fileName:g.fileName,contextPreview:this.plugin.settings.language==="en"?`Predicate "${s}" has low usage (${e.count} times): ${g.contextPreview}`:`\u8C13\u8BED "${s}" \u4F7F\u7528\u9891\u7387\u8FC7\u4F4E (${e.count} \u6B21): ${g.contextPreview}`,position:g.position,severity:"low",isIgnored:this.plugin.settings.ignoredIssues.includes(`${this.id}-${s}-${g.filePath}-${g.position.start}`)});let r=new Set;for(let[g,c]of t.entries())if(s!==g&&this.isSimilar(s,g)){let m=[s,g].sort().join("|");if(!r.has(m)&&(r.add(m),e.locations.length>0)){let l=e.locations[0];d.push({id:`${this.id}-${s}-${g}`,ruleId:this.id,filePath:l.filePath,fileName:l.fileName,contextPreview:this.plugin.settings.language==="en"?`Predicate "${s}" and "${g}" may have spelling similarity`:`\u8C13\u8BED "${s}" \u4E0E "${g}" \u53EF\u80FD\u5B58\u5728\u62FC\u5199\u76F8\u4F3C\u6027`,position:l.position,severity:"low",isIgnored:this.plugin.settings.ignoredIssues.includes(`${this.id}-${s}-${g}`)})}}}return d}isSimilar(d,i){let t=this.levenshteinDistance(d,i),s=Math.max(d.length,i.length);return s===0?!0:1-t/s>=.7}levenshteinDistance(d,i){let t=d.length,s=i.length,e=Array(t+1).fill(null).map(()=>Array(s+1).fill(0));for(let o=0;o<=t;o++)e[o][0]=o;for(let o=0;o<=s;o++)e[0][o]=o;for(let o=1;o<=t;o++)for(let r=1;r<=s;r++){let g=d[o-1]===i[r-1]?0:1;e[o][r]=Math.min(e[o-1][r]+1,e[o][r-1]+1,e[o-1][r-1]+g)}return e[t][s]}};var nt={requiredMetadataFields:["type","status","domain"],maxNoteLength:1500,minContextLength:50,excludedFolders:[],excludedTags:[],ignoredIssues:[],exportTemplate:'{"instruction": "\u8BF7\u6839\u636E\u4EE5\u4E0B\u5185\u5BB9\u751F\u6210\u77E5\u8BC6\u56FE\u8C31\u8282\u70B9\u548C\u5173\u7CFB", "input": {"content": {{content}}, "fileName": {{fileName}}, "filePath": {{filePath}}, "frontmatter": {{frontmatter}}}, "output": {"tags": {{tags}}, "type": {{type}}, "links": {{links}}, "headings": {{headings}}}}',knowledgeAtomTypes:["atom","concept","entity"],language:"zh",ruleWeights:{"metadata-integrity":5,"naked-links":2,"graph-connectivity":1,"note-atomicity":.8,"predicate-consistency":.5,"word-count-exceed":.1},predicateUsageThreshold:1,lastDiagnosisTime:0},F=class{constructor(){this.rules=new Map}static getInstance(){return F.instance||(F.instance=new F),F.instance}registerRule(d,i){this.rules.set(d,i)}getRules(d,i){return Array.from(this.rules.values()).map(t=>new t(d,i))}getRuleIds(){return Array.from(this.rules.keys())}},J=class extends Y.Plugin{async onload(){await this.loadSettings();let i=F.getInstance();i.registerRule("metadata-integrity",K),i.registerRule("note-atomicity",j),i.registerRule("naked-links",O),i.registerRule("graph-connectivity",B),i.registerRule("predicate-consistency",V);let t=this.settings.language==="en"?"Knowledge Ark Diagnostic Center":"\u77E5\u8BC6\u65B9\u821F\u8BCA\u65AD\u4E2D\u5FC3";this.addRibbonIcon("lucide-compass",t,e=>{this.activateView()}).addClass("knowledge-ark-ribbon-class"),this.registerView(S,e=>new z(e,this)),this.addSettingTab(new R(this.app,this)),this.addCommand({id:"open-knowledge-ark-view",name:this.settings.language==="en"?"Open Knowledge Ark Diagnostic Center":"\u6253\u5F00\u77E5\u8BC6\u65B9\u821F\u8BCA\u65AD\u4E2D\u5FC3",callback:()=>{this.activateView()}})}async onunload(){this.app.workspace.detachLeavesOfType(S)}async loadSettings(){this.settings=Object.assign({},nt,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async activateView(){let i=this.app.workspace.getLeavesOfType(S);if(i.length>0){let s=i[0];this.app.workspace.revealLeaf(s);return}let t=this.app.workspace.getRightLeaf(!1);t&&(await t.setViewState({type:S,active:!0}),this.app.workspace.revealLeaf(t))}async runDiagnostics(i=!1){let s=F.getInstance().getRules(this,this.app),e=this.settings.lastDiagnosisTime||0,o=this.app.vault.getMarkdownFiles(),r=o;i&&(r=o.filter(l=>l instanceof Y.TFile&&l.stat.mtime>e));let g=s.map(async l=>{try{let n=await l.check();return i?n.filter(a=>r.some(h=>h.path===a.filePath)):n}catch(n){return console.error(`Error running diagnostic rule ${l.name}:`,n),[]}}),m=(await Promise.all(g)).flat();return i&&(this.settings.lastDiagnosisTime=Date.now(),await this.saveSettings()),m}async exportHealthyNotes(i){await new D(this,this.app).exportHealthyNotes(i)}};
